<!DOCTYPE html>
<html>
    <head>
        <title>Itowns - Demonstration</title>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <script type="importmap">
            {
                "imports": {
                    "itowns": "../../dist/itowns.js",
                    "debug": "../../dist/debug.js",
                    "dat": "https://unpkg.com/dat.gui@0.7.9/build/dat.gui.module.js",
                    "GuiTools": "../jsm/GUI/GuiTools.js",
                    "LoadingScreen": "../jsm/GUI/LoadingScreen.js",
                    "itowns_widgets": "../../dist/itowns_widgets.js",
                    "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/"
                }
            }
        </script>

        <link rel="stylesheet" type="text/css" href="../css/example.css" />
        <link
            rel="stylesheet"
            type="text/css"
            href="../css/LoadingScreen.css"
        />
        <link rel="stylesheet" type="text/css" href="../css/widgets.css" />
    </head>
    <body>
        <div id="viewerDiv"></div>
        <script type="module">
            import GuiTools from "GuiTools";
            import setupLoadingScreen from "LoadingScreen";
            import * as THREE from "three";
            import * as itowns from "itowns";
            import * as debug from "debug";
            import * as itowns_widgets from "itowns_widgets";
            import { Scene1 } from "./scenes/Scene1.js";
            import { Scene2 } from "./scenes/Scene2.js";
            import { Scene3 } from "./scenes/Scene3.js";
            import { transitionToScene } from "./Utils/transitionToScene.js";

            // ---------- CREATE A GlobeView FOR SUPPORTING DATA VISUALIZATION : ----------

            // Define camera initial position
            const placement = {
                coord: new itowns.Coordinates("EPSG:4326", 80, 50),
                range: 25000000,
            };

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            const viewerDiv = document.getElementById("viewerDiv");

            // Create a GlobeView
            const view = new itowns.GlobeView(viewerDiv, placement);

            // Setup loading screen
            setupLoadingScreen(viewerDiv, view);

            // Deactivate camera controls
            view.controls.states.enabled = false;

            const orthoSource = new itowns.WMTSSource({
                url: "https://data.geopf.fr/wmts?",
                crs: "EPSG:3857",
                name: "ORTHOIMAGERY.ORTHOPHOTOS",
                tileMatrixSet: "PM",
                format: "image/jpeg",
            });
            const orthoLayer = new itowns.ColorLayer("Ortho", {
                source: orthoSource,
            });
            view.addLayer(orthoLayer);

            const elevationSource = new itowns.WMTSSource({
                url: "https://data.geopf.fr/wmts?",
                crs: "EPSG:4326",
                name: "ELEVATION.ELEVATIONGRIDCOVERAGE.SRTM3",
                tileMatrixSet: "WGS84G",
                format: "image/x-bil;bits=32",
                zoom: { min: 3, max: 10 },
            });
            const elevationLayer = new itowns.ElevationLayer("DEM", {
                source: elevationSource,
            });
            view.addLayer(elevationLayer);


            transitionToScene(view, null, Scene1);

            const scenes = [Scene1, Scene2, Scene3];
            let currentIndex = 0;

            const SceneManager = {
                next() {
                    const newIndex = (currentIndex + 1) % scenes.length;
                    transitionToScene(
                        view,
                        scenes[currentIndex],
                        scenes[newIndex]
                    );
                    currentIndex = newIndex;
                },
                previous() {
                    const newIndex =
                        (currentIndex - 1 + scenes.length) % scenes.length;
                    transitionToScene(
                        view,
                        scenes[currentIndex],
                        scenes[newIndex]
                    );
                    currentIndex = newIndex;
                },
            };

            // setTimeout(() => {
            //     SceneManager.next();
            //     setTimeout(() => {
            //         SceneManager.next();
            //         setTimeout(() => {
            //             SceneManager.next();
            //             setTimeout(() => {
            //                 SceneManager.previous();
            //             }, 5000);
            //         });
            //     }, 5000);
            // });

            const buttonContainer = document.createElement('div');
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.top = '20px';
            buttonContainer.style.right = '20px';
            buttonContainer.style.zIndex = '1000';

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous Scene';
            prevButton.onclick = () => SceneManager.previous();

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next Scene';
            nextButton.onclick = () => SceneManager.next();

            buttonContainer.appendChild(prevButton);
            buttonContainer.appendChild(nextButton);
            document.body.appendChild(buttonContainer);

            // // ---------- ADD SOME WIDGETS : ----------

            // // ADD A SCALE :
            // const scale = new itowns_widgets.Scale(view, {
            //     position: "bottom-right",
            //     translate: { x: -80 },
            // });

            // // ADD A MINIMAP :
            // const minimap = new itowns_widgets.Minimap(
            //     view,
            //     new itowns.ColorLayer("minimap", {
            //         source: new itowns.VectorTilesSource({
            //             style: "https://data.geopf.fr/annexes/ressources/vectorTiles/styles/PLAN.IGN/standard.json",
            //             // We don't display mountains and plot related data to ease visualisation
            //             filter: (layer) =>
            //                 !layer["source-layer"].includes("oro_") &&
            //                 !layer["source-layer"].includes("parcellaire"),
            //         }),
            //         addLabelLayer: { performance: true },
            //     }),
            //     { cursor: "+" }
            // );

            // // ---------- DISPLAY ATMOSPHERIC LIGHTING : ----------

            // const atmosphere = view.getLayerById("atmosphere");
            // atmosphere.setRealisticOn(true);
        </script>
    </body>
</html>
